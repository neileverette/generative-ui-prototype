---
phase: 33-widget-migration
plan: 01
type: execute
---

<objective>
Update ClaudeUsageCard component to fetch Console usage data from the EC2 GET endpoint instead of the local scraper file, enabling the widget to work from anywhere.

Purpose: Complete the scraper-to-EC2 data sync architecture by migrating the widget to consume synced data from EC2 rather than local files. This decouples the widget from the scraper's location.

Output: Widget fetches from `/api/claude/console-usage` (EC2 synced data) instead of `/api/claude-usage/console` (local scraper), with proper error handling and data freshness indicators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-ec2-get-endpoint/32-ec2-get-endpoint-PLAN.md
@.planning/phases/32-ec2-get-endpoint/32-ec2-get-endpoint-SUMMARY.md
@src/components/a2ui/ClaudeUsageCard.tsx
@src/services/mcp-client.ts
@server/index.ts

**Current Architecture:**
- ClaudeUsageCard calls `mcpClient.getConsoleUsage()` and `mcpClient.refreshConsoleUsage()`
- MCP client methods call `/api/claude-usage/console` and `/api/claude-usage/console/refresh`
- These endpoints read from local scraper file: `server/claude-scraper/usage-data.json`
- Limitation: Widget only works when running on same machine as scraper

**Phase 32 Complete:**
- GET endpoint at `/api/claude/console-usage` serves synced data from EC2
- Supports query parameters: `?version=N`, `?timestamp=ISO8601`
- Returns data with metadata: `isStale`, `ageMinutes`, `source: 'ec2-sync'`, `versionInfo`
- Cache headers vary by data freshness
- Response interface: `ConsoleUsageResponse` (extends `ConsoleUsageDataSync` with metadata)

**Target Architecture:**
- Widget calls new endpoint: `/api/claude/console-usage` (EC2 synced data)
- No more dependency on local scraper file location
- Widget works from any EC2 instance that has synced data
- Maintains same UI/UX (auto-refresh, manual refresh, staleness indicators)

**Key Decisions:**
- Remove `/api/claude-usage/console` endpoint (no longer needed, local scraper only)
- Remove manual refresh capability (sync happens server-side via scraper POST)
- OR: Keep manual refresh but have it return latest synced data (no server-side scrape)
- Decision: **Remove manual refresh** - the scraper handles syncing every 5 minutes. Widget just fetches latest.

**Backward Compatibility:**
- If no synced data exists (404), widget shows "No data available" error
- Widget already handles staleness indicators from existing endpoint
- Widget already shows data age in UI ("ageMinutes" field)
</context>

<tasks>

<task type="auto">
  <name>Update MCP Client to Use EC2 Sync Endpoint</name>
  <files>src/services/mcp-client.ts</files>
  <action>
Replace `getConsoleUsage()` method to call `/api/claude/console-usage` instead of `/api/claude-usage/console`.

Update method to:
1. Change URL from `${this.directBaseUrl}/claude-usage/console` to `${this.directBaseUrl}/claude/console-usage`
2. Update return type to match `ConsoleUsageResponse` from Phase 32 (includes versionInfo, source)
3. Keep same error handling pattern (throw on non-ok response)
4. Update console.log to indicate EC2 sync source: `[MCP Client] getConsoleUsage via EC2 sync endpoint`

Remove `refreshConsoleUsage()` method entirely:
- The scraper handles syncing every 5 minutes via POST to EC2
- Widget no longer triggers server-side scrapes
- Manual refresh button in widget will be removed in next task

Do NOT add environment variables or URL configuration - the endpoint path is hardcoded as part of the API contract.

Example:
```typescript
async getConsoleUsage(): Promise<ConsoleUsageResponse> {
  console.log('[MCP Client] getConsoleUsage via EC2 sync endpoint');

  const response = await fetch(`${this.directBaseUrl}/claude/console-usage`);

  if (!response.ok) {
    const error = await response.json().catch(() => ({ error: response.statusText }));
    throw new Error(error.error || `Failed to fetch console usage: ${response.statusText}`);
  }

  return response.json();
}
```
  </action>
  <verify>
1. Run `npm run build` - TypeScript compiles without errors
2. Search for `refreshConsoleUsage` in codebase - method only exists in ClaudeUsageCard (will be removed next task)
3. Grep for `/claude-usage/console` - should only appear in server/index.ts (old endpoint to be removed)
  </verify>
  <done>
- MCP client method updated to call `/api/claude/console-usage`
- Return type matches ConsoleUsageResponse interface
- refreshConsoleUsage method removed
- TypeScript build passes
- Console logs indicate EC2 sync source
  </done>
</task>

<task type="auto">
  <name>Update ClaudeUsageCard to Remove Manual Refresh</name>
  <files>src/components/a2ui/ClaudeUsageCard.tsx</files>
  <action>
Remove manual refresh functionality since scraper handles syncing:

1. In `fetchData()` function:
   - Remove `isManualRefresh` parameter entirely
   - Remove `isRefreshing` state variable (no longer needed)
   - Remove `setIsRefreshing(true/false)` calls
   - Remove the ternary that calls `mcpClient.refreshConsoleUsage()`
   - Always call `mcpClient.getConsoleUsage()` (fetch latest synced data)
   - Keep Promise.all pattern for parallel fetches

2. Remove refresh button from UI:
   - Delete the `<button onClick={() => fetchData(true)}` element in header
   - Keep the "Claude" title in header
   - No visual indication of manual refresh needed

3. Keep auto-refresh:
   - `useEffect` with 5-minute interval still calls `fetchData()` every 5 minutes
   - This fetches latest synced data from EC2

4. Update error handling:
   - Change error messages to reference "synced data" instead of "scraper"
   - Example: "No synced data available" or "Failed to fetch usage data from EC2"

Do NOT modify staleness indicators - the widget already shows `consoleUsage.isStale` and `ageMinutes` from the API response.

Why remove manual refresh: The scraper POSTs to EC2 every 5 minutes. Widget polling every 5 minutes is sufficient. Manual refresh would only re-fetch the same synced data, not trigger a new scrape.
  </action>
  <verify>
1. Run `npm run build` - TypeScript compiles without errors
2. Search codebase for `refreshConsoleUsage` - should not exist anywhere
3. Search codebase for `isRefreshing` - should not exist in ClaudeUsageCard
4. Verify `fetchData()` has no parameters (no isManualRefresh)
5. Verify auto-refresh interval still exists in useEffect
  </verify>
  <done>
- fetchData() simplified to always fetch latest synced data
- isRefreshing state removed
- Manual refresh button removed from UI
- Auto-refresh (5-min interval) still active
- Error messages reference synced data
- TypeScript build passes
  </done>
</task>

<task type="auto">
  <name>Remove Legacy Local Scraper Endpoints</name>
  <files>server/index.ts</files>
  <action>
Remove the old local scraper endpoints that are no longer needed:

1. Remove `GET /api/claude-usage/console` endpoint:
   - Find the route handler `app.get('/api/claude-usage/console', ...)`
   - Delete the entire route handler (typically 20-40 lines)
   - This endpoint reads from `usage-data.json` (local scraper file)
   - No longer needed since widget uses `/api/claude/console-usage`

2. Remove `POST /api/claude-usage/console/refresh` endpoint:
   - Find the route handler `app.post('/api/claude-usage/console/refresh', ...)`
   - Delete the entire route handler
   - This endpoint triggered immediate scraping
   - No longer needed since scraper handles syncing to EC2

3. Keep `GET /api/claude/console-usage` endpoint (Phase 32):
   - This is the NEW endpoint that serves synced data
   - Do NOT remove or modify this endpoint

4. Keep `POST /api/claude/console-usage` endpoint:
   - This is the sync endpoint that receives data from scraper
   - Do NOT remove or modify this endpoint

5. Add comment documenting the change:
```typescript
// Claude Console Usage - EC2 Sync Architecture
// Widget fetches from GET /api/claude/console-usage (synced data)
// Scraper POSTs to POST /api/claude/console-usage (sync new data)
// Legacy endpoints (local scraper file) removed in Phase 33
```

Why remove: The old endpoints read from local files which only exist on the scraper machine. The new architecture syncs data to EC2 via POST, serves via GET. Removing unused code prevents confusion.
  </action>
  <verify>
1. Run `npm run build` - TypeScript compiles without errors
2. Start server: `npm run dev` - server starts without errors
3. Grep for `/claude-usage/console` in server/index.ts - should NOT exist
4. Grep for `/claude/console-usage` in server/index.ts - should exist TWICE (GET and POST)
5. Check server startup logs - no errors about missing routes
  </verify>
  <done>
- Old GET /api/claude-usage/console endpoint removed
- Old POST /api/claude-usage/console/refresh endpoint removed
- New endpoints (GET/POST /api/claude/console-usage) remain
- Documentation comment added
- Server builds and starts successfully
- No TypeScript errors
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:

1. **Build verification:**
   ```bash
   npm run build
   ```
   - Frontend builds without TypeScript errors
   - Backend builds without TypeScript errors

2. **Code verification:**
   ```bash
   # Verify old endpoints removed
   grep -n "/claude-usage/console" server/index.ts
   # Should return: no results

   # Verify new endpoint exists
   grep -n "/claude/console-usage" server/index.ts
   # Should return: 2 results (GET and POST)

   # Verify refreshConsoleUsage removed
   grep -rn "refreshConsoleUsage" src/
   # Should return: no results
   ```

3. **Runtime verification (if EC2 has synced data):**
   ```bash
   npm run dev
   # Visit http://localhost:3000
   # Navigate to page with ClaudeUsageCard widget
   # Verify widget displays Console usage data
   # Verify no manual refresh button exists
   # Wait 5 minutes - verify auto-refresh fetches latest data
   ```

4. **Error handling verification (if no synced data):**
   - Widget should display: "No usage data available"
   - Error message should reference synced data or EC2
   - No console errors about missing endpoints

5. **Data freshness indicators:**
   - Widget shows staleness warning if data >10 minutes old
   - Widget shows data age in minutes
   - Widget indicates source as "ec2-sync"
</verification>

<success_criteria>

- MCP client calls `/api/claude/console-usage` instead of `/api/claude-usage/console`
- refreshConsoleUsage method removed from MCP client
- Manual refresh button removed from ClaudeUsageCard UI
- fetchData simplified to always fetch latest synced data
- Auto-refresh (5-min interval) still active
- Old local scraper endpoints removed from server
- New EC2 sync endpoints (GET/POST) remain unchanged
- TypeScript builds successfully (frontend and backend)
- Server starts without errors
- Widget displays synced data (if available) or appropriate error
- Staleness indicators continue to work
- No references to old endpoints in codebase
- Phase 33 complete, ready for Phase 34 (Error Handling & Fallbacks)

</success_criteria>

<output>
After completion, create `.planning/phases/33-widget-migration/33-01-SUMMARY.md`:

# Phase 33 Plan 01: Widget Migration Summary

**Migrated ClaudeUsageCard to fetch from EC2 sync endpoint, enabling widget to work from anywhere.**

## Accomplishments

- Updated MCP client to call `/api/claude/console-usage` (EC2 sync) instead of local scraper file
- Removed manual refresh functionality (scraper handles syncing every 5 minutes)
- Simplified fetchData to always fetch latest synced data
- Removed legacy local scraper endpoints (GET/POST `/api/claude-usage/console`)
- Widget now decoupled from scraper location - works on any EC2 instance with synced data

## Files Modified

- `src/services/mcp-client.ts` - Updated getConsoleUsage to use EC2 endpoint, removed refreshConsoleUsage
- `src/components/a2ui/ClaudeUsageCard.tsx` - Removed manual refresh button and isRefreshing state
- `server/index.ts` - Removed legacy local scraper endpoints, kept EC2 sync endpoints

## Architecture Changes

**Before:**
- Widget → `/api/claude-usage/console` → Local scraper file (`usage-data.json`)
- Limited to running on same machine as scraper

**After:**
- Scraper → POST `/api/claude/console-usage` → EC2 versioned storage
- Widget → GET `/api/claude/console-usage` → EC2 synced data
- Widget works from anywhere, not tied to scraper location

## Decisions Made

- **Removed manual refresh:** Scraper syncs every 5 minutes, widget polling every 5 minutes is sufficient. Manual refresh would only re-fetch same synced data without triggering new scrape.
- **Kept auto-refresh:** Widget still polls every 5 minutes for latest synced data.
- **Removed old endpoints:** `/api/claude-usage/console` endpoints are no longer needed and could cause confusion.

## Issues Encountered

None - straightforward migration. Widget already had staleness indicators that work with new endpoint.

## Next Phase Readiness

**Phase 34: Error Handling & Fallbacks**
- Add retry logic for failed fetches
- Add circuit breaker for repeated failures
- Add fallback messaging when EC2 data is unavailable
- Add health check endpoint for monitoring
- Consider stale data warnings when data >15 minutes old

Ready to proceed: Yes
</output>
