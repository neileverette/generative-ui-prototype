# Plan: Fix Chat Widget Results Display

## Objective

Fix the bug where typing a query in the chat that matches common phrases does not display corresponding widget results in the UI. When a user types a question/term that matches available actions (e.g., "Show all system metrics", "Show deployments"), the appropriate widgets should render in the dashboard canvas.

**Purpose**: Users should see visual widget results when their chat queries match available actions
**Output**: Working chat-to-widget flow with visible results for matching queries

## Execution Context

**Phase**: 5 - Fix Chat Widget Results
**Plan**: 05-01
**Estimated Scope**: Small (2-4 hours)
**Type**: Bug fix / Investigation

### Key Files

- `src/App.tsx` - CopilotKit integration with useCopilotAction hooks and state management
- `src/components/DashboardCanvas.tsx` - Renders components based on dashboardState
- `src/components/LandingPage.tsx` - Landing page with navigation

### Architecture

The expected flow when a user types in chat:
```
User types query in CopilotChat
  -> CopilotKit runtime processes message
    -> Matches query to useCopilotAction
      -> Action handler executes (e.g., fetchSystemMetrics)
        -> setDashboardState(components)
        -> setCurrentView('home')
          -> DashboardCanvas renders components
```

## Context

### Current Behavior (Bug)

When users type queries in the CopilotChat input that should trigger widget display:
- Chat message appears in the conversation
- Widget results do NOT appear in the dashboard canvas
- UI may stay on landing page or show no components

### Expected Behavior

When users type queries matching action descriptions:
- Chat message appears
- Loading state briefly shown
- Matching action handler executes
- Dashboard switches to 'home' view
- Relevant widgets/components render

### Known Working Patterns

From Phase 4, we know:
- NavigationCard clicks work (they call `handleCommandClick` -> `appendMessage`)
- Quick action buttons in chat panel work (they call `handleSendMessage` -> `appendMessage`)
- `appendMessage` successfully sends messages to CopilotKit

### Hypothesis

The issue is likely one of:
1. **CopilotKit action matching** - Actions may not be matching user input to action descriptions
2. **View state management** - `setCurrentView('home')` may not be called or not triggering re-render
3. **Component state** - `dashboardState.components` may be empty or not updating correctly
4. **CopilotKit runtime** - The runtime may not be processing messages correctly

## Tasks

### Task 1: Diagnose the Chat-to-Widget Flow

**Goal**: Identify exactly where the flow breaks between chat input and widget display

**Files**: `src/App.tsx`

**Action**:
Add console.log statements at key points to trace the flow:
1. In each `useCopilotAction` handler - log when handler is called
2. In `setDashboardState` calls - log the components being set
3. In state updates - log currentView changes

Focus on the `fetchSystemMetrics` action as a test case since "Show all system metrics" is a common query.

**Key Logging Points**:
```typescript
// In fetchSystemMetrics handler
console.log('[fetchSystemMetrics] Handler called');
// After data fetch
console.log('[fetchSystemMetrics] Data received:', data);
// Before setDashboardState
console.log('[fetchSystemMetrics] Setting components:', newComponents.length);
// Before setCurrentView
console.log('[fetchSystemMetrics] Setting view to home');
```

**Verify**:
1. Start dev server: `npm run dev`
2. Open browser console
3. Type "Show all system metrics" in chat
4. Check console for log output to see where flow stops

**Done**: Console logs reveal the exact failure point (action not called, data not fetched, or state not updated)

---

### Task 2: Verify CopilotKit Action Registration

**Goal**: Confirm actions are properly registered and can be invoked

**Files**: `src/App.tsx`

**Action**:
1. Verify CopilotKit provider wraps the component correctly (already wrapped with `<CopilotKit runtimeUrl="/api/copilotkit">`)
2. Check that all `useCopilotAction` hooks are inside the CopilotKit provider
3. Add a simple test action with logging to verify actions work at all:

```typescript
useCopilotAction({
  name: 'testAction',
  description: 'Test action for debugging. Use when user says "test action".',
  parameters: [],
  handler: async () => {
    console.log('[testAction] Handler executed successfully');
    return 'Test action completed';
  },
});
```

4. Test by typing "test action" in chat and checking console

**Verify**:
- Type "test action" in chat
- Check if `[testAction] Handler executed successfully` appears in console

**Done**: Understand whether actions are being matched and executed at all

---

### Task 3: Fix the Identified Issue

**Goal**: Apply the fix based on Task 1 and Task 2 findings

**Files**: `src/App.tsx` (and potentially other files based on diagnosis)

**Action**:
Based on diagnosis, apply one of these fixes:

**If actions aren't being called:**
- Check CopilotKit runtime configuration at `/api/copilotkit`
- Verify action descriptions are descriptive enough for matching
- Consider if the issue is with the CopilotKit backend/runtime

**If actions are called but state doesn't update:**
- Ensure `setCurrentView('home')` is called after `setDashboardState`
- Verify state updates are not being blocked or overwritten
- Check for race conditions between state updates

**If view updates but components don't render:**
- Check `DashboardCanvas` is receiving updated props
- Verify component registry has all required component types
- Check for rendering errors in console

**Implementation Notes**:
- Keep error handling from Phase 4 (try/catch, 30-second timeout)
- Add logging for debugging but make it conditional (can remove later)
- Ensure loading state transitions correctly: loading -> home with components

**Verify**:
1. Type "Show all system metrics" in chat
2. Loading indicator should appear briefly
3. Dashboard should show metric cards
4. No console errors

**Done**: Chat queries successfully trigger widget display

---

### Task 4: Test All Common Queries

**Goal**: Verify the fix works for all expected query types

**Files**: None (testing only)

**Action**:
Test each common query pattern:

| Query | Expected Action | Expected Result |
|-------|-----------------|-----------------|
| "Show all system metrics" | fetchSystemMetrics | Metric cards |
| "Show running containers" | fetchContainersList | Container table |
| "Show deployments" | showDeployments | Deployment table |
| "Show me AWS costs" | fetchCostsOverview | Cost cards |
| "Show Claude usage" | showClaudeUsage | Usage widget |
| "Show automation workflows" | fetchAutomations | Automation cards |

For each query:
1. Type in chat
2. Verify loading state
3. Verify correct widgets appear
4. Check no console errors

**Verify**: All 6 query types produce expected widget results

**Done**: All common queries work correctly

---

### Task 5: Clean Up Debug Logging

**Goal**: Remove excessive debug logging while keeping essential error logs

**Files**: `src/App.tsx`

**Action**:
1. Remove verbose console.log statements added during debugging
2. Keep console.error statements for actual errors
3. Optionally keep console.warn for fallback behaviors (timeouts, etc.)
4. Ensure code is production-ready

**Verify**:
- `npm run build` succeeds
- No TypeScript errors
- Console is clean during normal operation

**Done**: Code is clean and production-ready

## Verification

Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Chat input triggers widget display for matching queries
- [ ] All 6 common query types work correctly
- [ ] No console errors during normal operation
- [ ] UI transitions properly: landing -> loading -> results

## Success Criteria

- [ ] Typing "Show all system metrics" in chat displays metric cards
- [ ] Typing "Show deployments" in chat displays deployment table
- [ ] All 6 common query patterns produce correct widget results
- [ ] Loading state appears and resolves correctly
- [ ] No console errors during query processing
- [ ] Build passes (`npm run build`)

## Output

**Files Modified**:
- `src/App.tsx` - Debug logging and any fixes identified

**Testing**:
- Manual testing of all 6 query types
- Console monitoring for errors

**Summary**:
After completion, create `.planning/phases/phase-05-fix-chat-widgets/05-01-SUMMARY.md` with:
- Root cause identified
- Fix applied
- Test results
- Any remaining issues or observations
