# Plan: Debug and Fix Shortcut Card Click Handlers

## Objective

Fix the bug where clicking navigation/shortcut cards on the landing page causes the interface to become unresponsive. Clicking cards should trigger their intended navigation action without breaking the UI.

## Execution Context

**Phase**: 4 - Fix Shortcut Card Clicks
**Plan**: 04-01
**Estimated Scope**: Small (2-4 hours)
**Type**: Bug fix

### Key Files

- `src/App.tsx` - Main app with navigation handlers and CopilotKit integration
- `src/components/LandingPage.tsx` - Landing page with NavigationCard grid
- `src/components/a2ui/NavigationCard.tsx` - Card button component
- `src/components/DashboardCanvas.tsx` - View controller and shortcut rendering

## Context

### Current Behavior (Bug)

When clicking shortcut/navigation cards on the landing page, the interface becomes unresponsive or stops working entirely.

### Expected Behavior

Clicking a NavigationCard should:
1. Trigger the `onClick` handler
2. Call `onNavigate(destination)` in LandingPage
3. Map destination to a chat query in `handleNavigate`
4. Send the query via CopilotKit's `appendMessage`
5. Update the view to show loading state, then results

### Architecture Flow

```
NavigationCard (button onClick)
  -> LandingPage.onNavigate(destination)
    -> App.handleNavigate(destination)
      -> destinationQueries[destination] lookup
        -> handleCommandClick(query)
          -> setCurrentView('loading')
          -> appendMessage(TextMessage)
            -> CopilotKit processes
              -> Action handler (e.g., fetchSystemMetrics)
                -> setCurrentView('home')
                -> setDashboardState(components)
```

### Hypothesis

The bug is likely caused by one of:
1. **Unhandled promise rejection** - `appendMessage` or CopilotKit action failing silently
2. **State deadlock** - View stuck in 'loading' state if action never completes
3. **Event propagation issue** - Click handler causing React re-render loop
4. **CopilotKit error** - Message processing failing and not recovering

## Tasks

### Task 1: Reproduce and Diagnose the Bug

**Goal**: Confirm the bug and identify root cause using browser dev tools

**Steps**:
1. Start the dev server (`npm run dev`)
2. Open browser dev tools (Console + Network tabs)
3. Navigate to landing page
4. Click any NavigationCard (e.g., "Costs", "System metrics")
5. Observe:
   - Console errors or warnings
   - Network requests that fail
   - React component state changes (React DevTools)
   - Whether view changes to 'loading' and gets stuck

**Expected Findings**:
- Error message in console indicating the failure point
- Confirmation of which handler is failing

**Checkpoint**: Bug reproduced with clear error trace

---

### Task 2: Add Error Boundaries and Logging

**Goal**: Instrument the click handler chain with logging and error handling

**Steps**:
1. Add try/catch with console.error to `handleNavigate` in App.tsx
2. Add try/catch with console.error to `handleCommandClick` in App.tsx
3. Add error logging around the `appendMessage` call
4. Consider wrapping async handlers to catch rejections

**Code Changes** (App.tsx):
```typescript
const handleNavigate = useCallback((destination: string) => {
  console.log('[handleNavigate] destination:', destination);
  try {
    if (destination === 'back') {
      setCurrentView('landing');
      return;
    }
    const query = destinationQueries[destination];
    console.log('[handleNavigate] query:', query);
    if (query) {
      handleCommandClick(query);
    } else {
      console.error('[handleNavigate] No query found for destination:', destination);
    }
  } catch (error) {
    console.error('[handleNavigate] Error:', error);
  }
}, [handleCommandClick]);

const handleCommandClick = useCallback(async (query: string) => {
  console.log('[handleCommandClick] query:', query);
  try {
    setCurrentView('loading');
    await appendMessage(
      new TextMessage({
        role: MessageRole.User,
        content: query,
      })
    );
    console.log('[handleCommandClick] Message sent successfully');
  } catch (error) {
    console.error('[handleCommandClick] Error sending message:', error);
    // Recover from error by going back to landing
    setCurrentView('landing');
  }
}, [appendMessage]);
```

**Checkpoint**: Logging reveals exact failure point

---

### Task 3: Fix the Root Cause

**Goal**: Apply the appropriate fix based on diagnosis

**Potential Fixes** (apply based on Task 2 findings):

#### Fix A: Handle Async Errors in Message Flow
If `appendMessage` or CopilotKit action is failing:
- Add proper error recovery in `handleCommandClick`
- Implement a timeout to prevent infinite loading state
- Add fallback behavior when action fails

#### Fix B: Fix Event Handler Chain
If click events are causing issues:
- Ensure proper event.preventDefault() or event.stopPropagation() if needed
- Check for duplicate event handlers
- Verify React key props on NavigationCard elements

#### Fix C: Fix CopilotKit Integration
If the issue is with CopilotKit message processing:
- Check CopilotKit provider setup
- Verify action handlers are completing
- Add timeout/fallback for stuck states

**Implementation**:
Apply the fix that matches the diagnosed root cause.

**Checkpoint**: Click handler works without freezing UI

---

### Task 4: Add Recovery Mechanism

**Goal**: Prevent UI from getting stuck in loading state

**Steps**:
1. Add a loading timeout (e.g., 30 seconds) that reverts to landing if no response
2. Add a "Back" button or escape mechanism from loading state
3. Ensure error states provide user feedback

**Code Pattern**:
```typescript
// Add timeout to prevent stuck loading state
useEffect(() => {
  if (currentView === 'loading') {
    const timeout = setTimeout(() => {
      console.warn('Loading timeout - returning to landing');
      setCurrentView('landing');
    }, 30000); // 30 second timeout
    return () => clearTimeout(timeout);
  }
}, [currentView]);
```

**Checkpoint**: UI never gets permanently stuck

---

### Task 5: Test All Navigation Cards

**Goal**: Verify fix works for all navigation paths

**Test Matrix**:
| Card | Destination | Query | Expected Result |
|------|-------------|-------|-----------------|
| Costs | costs | "Show me AWS costs breakdown" | Cost components display |
| System metrics | system-metrics | "Show all system metrics" | Metric cards display |
| Automations | automations | "Show automation workflows status" | Automation status |
| Applications | applications | "Show running containers" | Container list |
| Deployments | deployments | "Show deployments" | Deployment table |
| AI usage | ai-usage | "Show Claude usage" | Usage widget |

**Steps**:
1. Click each NavigationCard
2. Verify loading state appears briefly
3. Verify correct components render
4. Verify no console errors

**Checkpoint**: All 6 navigation cards work correctly

---

### Task 6: Clean Up Debug Logging

**Goal**: Remove or reduce debug logging for production

**Steps**:
1. Remove verbose console.log statements
2. Keep console.error for genuine errors
3. Optionally keep console.warn for timeouts/fallbacks

**Checkpoint**: Code is production-ready

## Verification

Run the following to verify the fix:

```bash
# Start dev server
npm run dev

# In browser:
# 1. Navigate to http://localhost:3000
# 2. Click each navigation card
# 3. Verify each loads content correctly
# 4. Check console for any errors
```

**Success Criteria**:
- All 6 navigation cards respond to clicks
- UI transitions from landing -> loading -> results
- No console errors during normal operation
- UI recovers gracefully if CopilotKit fails

## Success Criteria

- [ ] Bug is reproduced and root cause identified
- [ ] Click handlers include proper error handling
- [ ] All NavigationCard clicks trigger correct navigation
- [ ] UI never gets permanently stuck in loading state
- [ ] No console errors during normal operation
- [ ] Build passes (`npm run build`)

## Output

**Files Modified**:
- `src/App.tsx` - Error handling in navigation handlers
- Potentially: `src/components/LandingPage.tsx` or `src/components/DashboardCanvas.tsx`

**Testing**:
- Manual testing of all 6 navigation cards
- Console monitoring for errors

**Next Phase**: Phase 5 - Fix Chat Widget Results
