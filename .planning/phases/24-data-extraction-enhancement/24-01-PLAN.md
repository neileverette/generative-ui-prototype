---
phase: 24-data-extraction-enhancement
plan: 01
type: execute
---

<objective>
Extract plan information (name, tier, cost, billing date) from Claude Console to replace fake plan data in frontend.

Purpose: Provide real subscription and billing details to users in ClaudeUsageCard, completing the data hydration started in Milestone 5.

Output: Enhanced scraper that extracts plan info alongside current session and weekly limits data, with graceful degradation if plan section unavailable.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-data-extraction-enhancement/DISCOVERY.md
@.planning/phases/23-error-handling/23-02-SUMMARY.md
@server/claude-scraper/scrape.ts
@server/claude-scraper/auto-scraper.ts
@src/components/a2ui/ClaudeUsageCard.tsx

**Tech stack available:**
- Playwright for headless browser automation
- TypeScript with Node.js
- Existing session management and retry logic

**Established patterns:**
- Section-independent extraction with individual try/catch blocks
- 5-second timeout per section for fast failure
- Graceful degradation with isPartial flag and extractionErrors tracking
- Optional interface fields for each data section

**Constraining decisions from Phase 23:**
- Each new data section extracts independently in its own try/catch
- Partial success (N-1 sections) treated as success, not failure
- Update sectionsExtracted count and totalSections count
- Add errors to extractionErrors record on section failure
- Make all new interface fields optional (planInfo?)

**Frontend expectations:**
ClaudeUsageCard expects PlanConfig interface:
```typescript
interface PlanConfig {
  name: string;       // e.g., "Claude Pro"
  tier: string;       // e.g., "Pro"
  cost: string;       // e.g., "$20/month"
  nextBillingDate: string;  // ISO date or formatted string
}
```

**Research needed:**
Console DOM structure for plan/billing information requires manual exploration to identify exact selectors.
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Manually explore Claude Console to identify plan info selectors</action>
  <instructions>
    The scraper needs DOM selectors for plan information. Since Console UI structure may vary by account type and isn't documented, manual exploration is required.

    Steps:
    1. Ensure you have a valid session: Run `npx tsx server/claude-scraper/login.ts` if needed
    2. Open browser and navigate to: https://console.anthropic.com/settings/usage
    3. Open DevTools (F12) and inspect the page structure
    4. Look for sections containing:
       - Plan name (e.g., "Claude Pro", "Claude Team")
       - Tier level (e.g., "Pro", "Team")
       - Subscription cost (e.g., "$20/month", "$30/month")
       - Next billing date or billing cycle info
    5. If not on usage page, check: https://console.anthropic.com/settings/billing
    6. Document the following:
       - Page URL where plan info is located (usage or billing page?)
       - Text selectors (e.g., 'text=Subscription', 'text=Billing')
       - DOM structure (div classes, data attributes)
       - Example text content for each field

    Alternative: If plan info is not visible in Console UI, document this finding. The task will adapt to extract only what's available.
  </instructions>
  <verification>After exploration, you'll provide the DOM structure findings</verification>
  <resume-signal>
    Provide findings in this format:
    ```
    Page: [usage or billing]
    Plan name selector: [text or class]
    Tier selector: [text or class]
    Cost selector: [text or class]
    Billing date selector: [text or class]
    Example content: [paste example text]
    ```
    Or reply "not-available" if plan info not found in Console UI.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Update ConsoleUsageData interface with plan info</name>
  <files>server/claude-scraper/scrape.ts</files>
  <action>
    Add planInfo field to ConsoleUsageData interface:
    ```typescript
    export interface ConsoleUsageData {
      currentSession?: { ... };
      weeklyLimits?: { ... };

      // Plan information from Console
      planInfo?: {
        name: string;        // Plan name (e.g., "Claude Pro")
        tier: string;        // Tier level (e.g., "Pro")
        cost: string;        // Monthly cost (e.g., "$20/month")
        nextBillingDate: string;  // Next billing date
      };

      lastUpdated: string;
      extractionErrors?: Record<string, string>;
      isPartial?: boolean;
    }
    ```

    Make planInfo optional (planInfo?) to maintain graceful degradation pattern. This allows scraper to save partial data if plan info extraction fails.
  </action>
  <verify>TypeScript compilation succeeds: `npx tsc --noEmit server/claude-scraper/scrape.ts`</verify>
  <done>ConsoleUsageData interface includes optional planInfo field, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 3: Implement plan info extraction with section-independent error handling</name>
  <files>server/claude-scraper/scrape.ts, server/claude-scraper/auto-scraper.ts</files>
  <action>
    **In scrape.ts:**

    1. Update totalSections from 3 to 4 to account for new plan info section

    2. Add plan info extraction block AFTER weekly limits extraction (before section count check):
    ```typescript
    // Extract plan info
    let planInfo: { name: string; tier: string; cost: string; nextBillingDate: string } | undefined;
    try {
      // Use selectors from Task 1 checkpoint findings
      // If on separate billing page, navigate there first
      // Implement DOM extraction based on documented structure
      // Extract name, tier, cost, nextBillingDate fields

      if (planInfo && planInfo.name) {  // Validate required field
        sectionsExtracted++;
        console.log('[Scraper] Plan info extracted successfully');
      } else {
        extractionErrors['planInfo'] = 'Data not found in DOM';
        console.warn('[Scraper] Plan info: Data not found');
      }
    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : String(err);
      extractionErrors['planInfo'] = errorMsg;
      console.warn('[Scraper] Plan info extraction failed:', errorMsg);
    }
    ```

    3. Add planInfo to usageData object construction (after weeklyLimits):
    ```typescript
    if (planInfo) {
      usageData.planInfo = planInfo;
    }
    ```

    4. Follow Phase 23 patterns:
       - 5-second timeout for selector wait
       - Individual try/catch block
       - Log success/failure clearly
       - Add to extractionErrors on failure
       - Validate extracted data before counting as successful

    **In auto-scraper.ts:**

    Update section counting logic to include plan info:
    ```typescript
    let totalSections = 4; // was 3, now includes planInfo
    // ... existing counting logic ...
    if (usageData.planInfo) sectionsExtracted++;
    ```

    **Important:**
    - If Task 1 checkpoint reveals plan info is not available in Console UI, implement as extraction attempt that gracefully fails (extractionErrors['planInfo'] = 'Not available in Console UI')
    - If plan info requires navigating to separate billing page, add navigation step with timeout
    - Maintain existing extraction for currentSession and weeklyLimits (don't break what works)
  </action>
  <verify>
    1. TypeScript compilation: `npx tsc --noEmit server/claude-scraper/scrape.ts server/claude-scraper/auto-scraper.ts`
    2. Test scrape (if session valid): `npx tsx server/claude-scraper/scrape.ts`
    3. Check usage-data.json includes planInfo field (or extractionErrors['planInfo'] if not available)
    4. Verify sectionsExtracted count and isPartial flag are correct
  </verify>
  <done>
    - scrape.ts extracts plan info in section-independent block
    - auto-scraper.ts counts plan info in sectionsExtracted (4 total sections)
    - usage-data.json contains planInfo field when available
    - Graceful degradation if plan info extraction fails (partial data saved)
    - No errors or warnings during compilation
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript builds without errors
- [ ] Test scrape completes (with or without plan info depending on availability)
- [ ] usage-data.json structure includes planInfo field or extractionErrors['planInfo']
- [ ] Section counting logic correctly reflects 4 total sections
- [ ] Graceful degradation maintained (partial success still saves data)
- [ ] No regressions to existing currentSession or weeklyLimits extraction
</verification>

<success_criteria>

- All tasks completed
- ConsoleUsageData interface extended with optional planInfo field
- Plan info extraction implemented following section-independent pattern from Phase 23
- Auto-scraper section counting updated to include plan info
- Graceful degradation if plan info unavailable (isPartial flag set correctly)
- No TypeScript errors or build failures
- Test scrape produces valid usage-data.json with plan info or appropriate error
  </success_criteria>

<output>
After completion, create `.planning/phases/24-data-extraction-enhancement/24-01-SUMMARY.md`:

# Phase 24 Plan 1: Plan Info Extraction Summary

**[One-line description of what was accomplished - e.g., "Added plan information extraction to scraper with graceful degradation"]**

## Accomplishments

- Extended ConsoleUsageData interface with planInfo field
- Implemented section-independent extraction for plan details (name, tier, cost, billing date)
- Updated auto-scraper to count 4 total sections
- Maintained graceful degradation pattern from Phase 23

## Files Created/Modified

- `server/claude-scraper/scrape.ts` - Extended interface, added plan info extraction
- `server/claude-scraper/auto-scraper.ts` - Updated section counting to 4

## Decisions Made

[Key decisions made during implementation, or "None"]

## Issues Encountered

[Problems faced and how they were resolved, or "None"]

## Next Phase Readiness

[If plan info extraction revealed additional data opportunities, note them here]
[If more plans needed for Phase 24, describe next plan scope]
[If Phase 24 complete, state "Phase 24 complete, ready for Phase 25"]
</output>
