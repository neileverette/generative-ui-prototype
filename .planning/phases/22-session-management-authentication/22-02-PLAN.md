---
phase: 22-session-management-authentication
plan: 02
type: execute
---

<objective>
Implement session recovery mechanisms and enhanced error handling for authentication failures.

Purpose: Minimize manual intervention by attempting session refresh and providing clear recovery paths for different failure modes.
Output: Enhanced error handling with session recovery attempts and detailed troubleshooting guidance.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-session-management-authentication/22-01-SUMMARY.md
@server/claude-scraper/scrape.ts
@server/claude-scraper/auto-scraper.ts
@server/claude-scraper/session-validator.ts

**From Plan 1:**
- Session validation now runs before scraping
- Session expiration detected early with clear messages
- validateSession() provides reason for failures

**Current gaps:**
- No automatic session recovery attempts
- All auth failures treated the same way
- Limited troubleshooting information
- No session metadata tracking (age, last validation)

**Tech stack available:**
- Playwright browser automation
- Session validator module
- Persistent context in .session/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session recovery with browser refresh attempt</name>
  <files>server/claude-scraper/session-validator.ts</files>
  <action>
Enhance session validator with recovery capabilities:

1. Add new function `attemptSessionRecovery(): Promise<SessionRecoveryResult>`:
   - Launch browser with persistent context (headless: false - user needs to see)
   - Navigate to https://console.anthropic.com/settings/usage
   - Wait up to 30 seconds for either:
     a) Auto-redirect/refresh succeeds → authentication recovered
     b) Login page appears → recovery failed, manual login needed
     c) Timeout → network or loading issue
   - Return result: { recovered: boolean, action: 'auto-refreshed' | 'manual-login-required' | 'network-error', timestamp: string }
   - Keep browser open if manual login required (user can complete it)
   - Close browser if auto-recovery succeeded

2. Modify validateSession to accept optional parameter `attemptRecovery: boolean = false`
3. When attemptRecovery is true and validation fails, automatically call attemptSessionRecovery()
4. Return combined result including recovery attempt outcome

This allows one-click recovery for soft session expirations (cookies stale but can refresh) while still detecting hard failures (full re-login needed).

DO NOT auto-recover by default - only when explicitly requested. This prevents unexpected browser windows during normal operation.
  </action>
  <verify>
1. TypeScript compiles: npx tsc --noEmit
2. attemptSessionRecovery function exists and is exported
3. validateSession accepts attemptRecovery parameter
4. Recovery attempt only happens when explicitly enabled
  </verify>
  <done>
- attemptSessionRecovery function implemented
- Browser stays open when manual login needed
- Browser closes automatically when auto-recovery succeeds
- Recovery only runs when explicitly requested
- Clear recovery result with specific action needed
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance error handling with categorization and troubleshooting</name>
  <files>server/claude-scraper/scrape.ts, server/claude-scraper/auto-scraper.ts</files>
  <action>
Improve error handling to distinguish failure types and provide specific guidance:

In scrape.ts:
1. On session validation failure, check validation reason:
   - "Current session" text not found → likely expired session
   - Navigation timeout → network or Console unavailable
   - Browser context launch failed → .session directory corrupted
2. Attempt recovery for likely-expired sessions: call validateSession(attemptRecovery: true)
3. If recovery succeeds, continue with scrape normally
4. If recovery fails, throw categorized error with specific message

In auto-scraper.ts:
1. Categorize errors by type:
   - Session expired: "Session expired. Attempted auto-recovery failed. Run: npx tsx server/claude-scraper/login.ts"
   - Network issues: "Network timeout accessing Console. Check connection and try again in 5 minutes."
   - Context corrupted: "Browser session corrupted. Delete server/claude-scraper/.session/ and run login.ts"
   - Unknown: Generic error message with full error details
2. Add session age tracking: log when session was last validated successfully
3. Improve existing error messages from MAX_ERRORS logic:
   - Before: "Too many consecutive errors. Stopping."
   - After: "Stopped after {N} consecutive failures. Last error: {category}. {specific-action}"
4. Add --verbose flag support (check process.argv) to log detailed session validation info

This ensures users get actionable guidance based on the actual failure mode, reducing guesswork.
  </action>
  <verify>
1. Build succeeds: npm run build
2. Different error types produce different messages
3. Session recovery attempt runs for expired sessions
4. Error categorization logic is correct
5. Troubleshooting messages are clear and actionable
  </verify>
  <done>
- Session errors categorized (expired, network, corrupted, unknown)
- Auto-recovery attempts for expired sessions
- Specific troubleshooting steps for each error type
- Session age tracking added
- Verbose logging option available
- No TypeScript errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript builds without errors: npm run build
- [ ] Session recovery function works correctly
- [ ] Error categorization provides specific, actionable messages
- [ ] Auto-recovery only runs when appropriate
- [ ] Manual login guidance is clear for each failure type
</verification>

<success_criteria>

- Session recovery mechanism implemented
- Auto-recovery attempts for soft session expirations
- Error handling distinguishes between failure types
- Users get specific troubleshooting steps based on error
- Phase 22 complete - ready for Phase 23
</success_criteria>

<output>
After completion, create `.planning/phases/22-session-management-authentication/22-02-SUMMARY.md`:

# Phase 22 Plan 2: Session Recovery Summary

**Added session recovery mechanism and categorized error handling with specific troubleshooting guidance.**

## Accomplishments

- Implemented automatic session recovery for soft expirations
- Categorized errors (expired, network, corrupted, unknown)
- Specific troubleshooting messages for each failure type
- Session age tracking for debugging

## Files Created/Modified

- `server/claude-scraper/session-validator.ts` - Added recovery mechanism
- `server/claude-scraper/scrape.ts` - Enhanced error handling with recovery attempts
- `server/claude-scraper/auto-scraper.ts` - Categorized errors, improved messaging

## Decisions Made

- Auto-recovery only for soft expirations (not default behavior)
- Keep browser open when manual login required (user can complete it)
- Close browser automatically when recovery succeeds

## Issues Encountered

None

## Next Step

Phase 22 complete. Ready for Phase 23: Error Handling & Retry Logic
</output>
