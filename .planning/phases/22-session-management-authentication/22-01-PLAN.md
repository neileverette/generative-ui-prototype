---
phase: 22-session-management-authentication
plan: 01
type: execute
---

<objective>
Implement session validation and health checking to detect session expiration before scraping attempts.

Purpose: Prevent scraper failures due to expired sessions by proactively validating authentication state.
Output: Session health check module with validation logic integrated into scraper startup.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/claude-scraper/scrape.ts
@server/claude-scraper/login.ts
@server/claude-scraper/auto-scraper.ts

**Current session management:**
- Persistent browser context stored in `server/claude-scraper/.session/`
- Manual login via `login.ts` creates session
- `scrape.ts` uses `launchPersistentContext` to reuse session
- No validation before scraping - fails if session expired
- Error handling limited to retry counter (3 max)

**Tech stack available:**
- Playwright for browser automation
- TypeScript/Node.js
- Existing session persistence directory

**Issues being addressed:**
- Session expires unpredictably requiring manual re-login
- No proactive session validation
- No graceful handling of auth failures
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session health check module</name>
  <files>server/claude-scraper/session-validator.ts</files>
  <action>
Create a new module that validates session health by:
1. Check if .session directory exists and contains necessary browser context files
2. Launch browser with persistent context in headless mode
3. Navigate to https://console.anthropic.com/settings/usage
4. Check for authentication indicators:
   - Presence of "Current session" text (authenticated)
   - Redirect to login page (session expired)
   - Timeout after 10 seconds (network/loading issue)
5. Return validation result: { valid: boolean, reason?: string, timestamp: string }
6. Close browser cleanly after validation

Export async function `validateSession(): Promise<SessionValidationResult>`.

Handle errors gracefully - network timeouts, navigation failures, context launch failures should return valid: false with descriptive reason.

DO NOT use puppeteer - use Playwright (already in use). DO NOT modify existing files yet - this is a standalone utility.
  </action>
  <verify>
1. TypeScript compiles without errors: npx tsc --noEmit
2. Module exports validateSession function with correct signature
3. Function can be imported: import { validateSession } from './session-validator'
  </verify>
  <done>
- session-validator.ts exists and exports validateSession
- TypeScript types are correct
- Module follows existing Playwright patterns from scrape.ts
- Error handling prevents crashes on network/context failures
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate session validation into scraper startup</name>
  <files>server/claude-scraper/scrape.ts, server/claude-scraper/auto-scraper.ts</files>
  <action>
Modify scraper to validate session before scraping:

In scrape.ts:
1. Import validateSession from session-validator
2. Add session check at start of scrape() function before launching browser
3. If validation fails:
   - Log clear error: "[Scraper] Session expired or invalid: {reason}"
   - Throw error with message: "Session validation failed: {reason}. Run login.ts to re-authenticate."
4. If validation succeeds, log: "[Scraper] Session validated successfully" and proceed

In auto-scraper.ts:
1. Catch session validation errors specifically (check error message for "Session validation failed")
2. Provide helpful error message directing user to run login.ts
3. Keep existing error counter logic but add session-specific messaging
4. DO NOT auto-retry on session failures (manual login required)

This ensures session problems are detected immediately with clear instructions, rather than failing during scrape attempts.
  </action>
  <verify>
1. Build succeeds: npm run build
2. TypeScript compiles without errors
3. Session validation runs before browser launch
4. Error messages are clear and actionable
  </verify>
  <done>
- scrape.ts validates session at startup
- auto-scraper.ts provides clear session error handling
- Session failures exit quickly with helpful messages
- No TypeScript errors introduced
- Existing scraper functionality unchanged when session is valid
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript builds without errors: npm run build
- [ ] Session validator can be imported and used standalone
- [ ] scrape.ts validates session before launching browser
- [ ] Clear error messages guide users to run login.ts when session invalid
- [ ] No changes break existing scraper when session is valid
</verification>

<success_criteria>

- Session health check module created and working
- Scraper validates session before every scrape attempt
- Failed session validation provides clear instructions
- No TypeScript errors or build issues
- Existing functionality preserved for valid sessions
</success_criteria>

<output>
After completion, create `.planning/phases/22-session-management-authentication/22-01-SUMMARY.md`:

# Phase 22 Plan 1: Session Validation Summary

**Added proactive session health checks to detect expired sessions before scraping.**

## Accomplishments

- Created session-validator.ts module for authentication state checking
- Integrated validation into scraper startup flow
- Clear error messages guide users to re-authenticate when needed

## Files Created/Modified

- `server/claude-scraper/session-validator.ts` - New session health check module
- `server/claude-scraper/scrape.ts` - Added session validation at startup
- `server/claude-scraper/auto-scraper.ts` - Improved session error handling

## Decisions Made

None

## Issues Encountered

None

## Next Step

Ready for 22-02-PLAN.md (Session recovery and enhanced error handling)
</output>
