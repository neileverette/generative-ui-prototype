---
phase: 29-ec2-api-endpoint
plan: 01
type: execute
---

<objective>
Create a POST endpoint on EC2 to receive and store Claude Console usage data from the laptop scraper.

Purpose: Enable the scraper running on the laptop to sync usage data to EC2, decoupling data collection from data serving. This is the first step in making the usage widget work from anywhere, not just the laptop running the scraper.

Output: Working POST /api/claude/console-usage endpoint that accepts usage data, validates it, authenticates requests, and stores to disk.
</objective>

<execution_context>
@/Users/neileverette/.claude/get-shit-done/workflows/execute-phase.md
@/Users/neileverette/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/neileverette/Desktop/generative-ui-prototype/.planning/PROJECT.md
@/Users/neileverette/Desktop/generative-ui-prototype/.planning/ROADMAP.md
@/Users/neileverette/Desktop/generative-ui-prototype/.planning/STATE.md

**Relevant source files:**
@/Users/neileverette/Desktop/generative-ui-prototype/server/index.ts
@/Users/neileverette/Desktop/generative-ui-prototype/server/claude-scraper/usage-data.json

**Current architecture:**
- Scraper runs locally on laptop at server/claude-scraper/
- Writes data to local file: server/claude-scraper/usage-data.json
- Data structure includes: currentSession, weeklyLimits (allModels, sonnetOnly), lastUpdated
- Widget reads from local file only (works only on same machine)

**Target architecture (this phase):**
- Create POST endpoint on EC2: /api/claude/console-usage
- Accept JSON payload with same structure as usage-data.json
- Authenticate requests using API key in header
- Validate incoming data structure
- Store to filesystem (simple JSON file for now)
- Return success/error status

**Data structure to accept:**
```json
{
  "currentSession": {
    "resetsIn": "2 hr 42 min",
    "percentageUsed": 47
  },
  "weeklyLimits": {
    "allModels": {
      "resetsIn": "Thu 7:00 AM",
      "percentageUsed": 31
    },
    "sonnetOnly": {
      "resetsIn": "Sat 12:00 PM",
      "percentageUsed": 10
    }
  },
  "lastUpdated": "2026-01-25T03:17:41Z",
  "isPartial": false,
  "extractionErrors": {}
}
```

**Security considerations:**
- API key authentication required (header: X-API-Key)
- Validate schema before accepting
- Rate limiting not needed yet (single source, 5-min intervals)
- Input validation for all fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript interfaces for Console usage data</name>
  <files>server/claude-console-sync.d.ts</files>
  <action>Create type definitions file for Console usage data sync. Define ConsoleUsageDataSync interface matching the scraper's output structure (currentSession with resetsIn and percentageUsed, weeklyLimits with allModels and sonnetOnly, lastUpdated ISO string, optional isPartial boolean, optional extractionErrors object). Add SyncResponse interface for endpoint responses (success boolean, message string, timestamp string). Export both interfaces for use in server and future client code.</action>
  <verify>TypeScript compilation passes, no errors in server/index.ts when importing types</verify>
  <done>Type definitions exist and compile cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create POST endpoint with authentication and validation</name>
  <files>server/index.ts</files>
  <action>Add POST /api/claude/console-usage endpoint after existing Claude usage endpoints (around line 1950). Accept JSON body with ConsoleUsageDataSync structure. Validate X-API-Key header against environment variable CLAUDE_SYNC_API_KEY (return 401 if missing/invalid). Validate request body schema: require currentSession and weeklyLimits objects, validate percentageUsed is 0-100, validate resetsIn strings are non-empty, validate lastUpdated is valid ISO string. Return 400 for invalid data with specific error messages. Use fs.writeFileSync to save validated data to server/claude-scraper/console-usage-synced.json (separate from local usage-data.json). Return 200 with { success: true, message: 'Usage data synced', timestamp: new Date().toISOString() }. Add error handling for filesystem errors (return 500). Log successful syncs with timestamp and data freshness.</action>
  <verify>curl -X POST http://localhost:4000/api/claude/console-usage -H "X-API-Key: test-key" -H "Content-Type: application/json" -d @server/claude-scraper/usage-data.json returns 200 or 401 based on API key validity</verify>
  <done>Endpoint accepts valid payloads with correct API key, rejects invalid API keys with 401, rejects invalid schemas with 400, saves data to console-usage-synced.json, returns success response</done>
</task>

<task type="auto">
  <name>Task 3: Add environment variable and documentation</name>
  <files>.env.local.example, server/index.ts</files>
  <action>Add CLAUDE_SYNC_API_KEY to .env.local.example with comment explaining it's used for scraper-to-EC2 sync authentication. In server/index.ts, add environment variable loading at the top (around line 40) for CLAUDE_SYNC_API_KEY with validation check (warn if not set but don't exit - allow local dev without it). Add console log on server startup showing whether sync endpoint is configured (API key present) or not. Update existing .env.local file if it exists (don't commit actual key).</action>
  <verify>grep CLAUDE_SYNC_API_KEY .env.local.example shows the variable, server starts and logs sync endpoint status</verify>
  <done>.env.local.example has CLAUDE_SYNC_API_KEY, server checks for API key on startup, logs configuration status</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] Server starts without errors
- [ ] POST endpoint accepts valid data with correct API key
- [ ] POST endpoint rejects requests with missing/invalid API key (401)
- [ ] POST endpoint rejects invalid data structure (400)
- [ ] Data saves to server/claude-scraper/console-usage-synced.json
- [ ] Response includes success status and timestamp
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- POST /api/claude/console-usage endpoint working
- Authentication via X-API-Key header enforced
- Input validation prevents invalid data
- Data persists to filesystem
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `/Users/neileverette/Desktop/generative-ui-prototype/.planning/phases/29-ec2-api-endpoint/29-01-SUMMARY.md`:

# Phase 29 Plan 1: EC2 API Endpoint Summary

**[One-liner describing what shipped]**

## Accomplishments

- Created TypeScript interfaces for Console usage data sync
- Implemented POST /api/claude/console-usage endpoint with API key authentication
- Added request validation for usage data structure
- File-based storage for synced data (console-usage-synced.json)
- Environment variable configuration for API key

## Files Created/Modified

- `server/claude-console-sync.d.ts` - Type definitions for sync data
- `server/index.ts` - POST endpoint with auth and validation
- `.env.local.example` - API key configuration example

## Decisions Made

- API key authentication via X-API-Key header (simple, sufficient for single client)
- Separate file for synced data (console-usage-synced.json) to avoid conflicts with local scraper
- Schema validation in endpoint (fail fast on invalid data)
- 401 for auth failures, 400 for validation failures, 500 for server errors

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 30 (Data Sync Client) - endpoint is available for scraper to POST to.

**Note for Phase 30:** Use X-API-Key header with CLAUDE_SYNC_API_KEY value for authentication.
</output>
