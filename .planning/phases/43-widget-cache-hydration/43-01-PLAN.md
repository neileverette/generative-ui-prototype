---
phase: 43-widget-cache-hydration
plan: 01
type: execute
---

<objective>
Add cache hydration to ClaudeUsageCard widget to display cached data immediately on mount, then fetch fresh data in background.

Purpose: Eliminate loading delays by showing cached data instantly, creating app-like experience where widgets appear immediately on page load.
Output: ClaudeUsageCard displays cached data on mount with staleness indicator, updates smoothly when fresh data arrives.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-cache-storage-architecture/42-01-SUMMARY.md
@src/utils/widget-cache.ts
@src/components/a2ui/ClaudeUsageCard.tsx
@src/services/mcp-client.ts

**Tech stack available:**
- localStorage-based widget cache (Phase 42)
- TypeScript generic cache operations
- React hooks (useState, useEffect)

**Established patterns:**
- `getCachedWidget<T>(widgetType, cacheKey)` - Type-safe cache retrieval
- `setCachedWidget<T>(widgetType, cacheKey, data)` - Save with timestamp
- `isCacheStale(entry, maxAgeMs)` - Staleness detection
- `getCacheAge(entry)` - Age in milliseconds

**Constraining decisions:**
- Phase 42: Silent error handling for cache operations (never break widgets)
- Phase 42: Cache key structure `{widgetType}:{cacheKey}`
- Phase 42: 5-10 minute staleness threshold typical

**Cache integration pattern from Phase 42:**
```typescript
const cached = getCachedWidget<UsageData>('widget-type', 'cache-key');
if (cached) {
  setData(cached.data);
  setIsStale(isCacheStale(cached, 5 * 60 * 1000)); // 5 min threshold
}
fetchFreshData().then(fresh => {
  setData(fresh);
  setIsStale(false);
  setCachedWidget('widget-type', 'cache-key', fresh);
});
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cache hydration on component mount</name>
  <files>src/components/a2ui/ClaudeUsageCard.tsx</files>
  <action>
Import getCachedWidget, setCachedWidget, isCacheStale, getCacheAge from widget-cache.ts.

On component mount (before fetchData), check cache using:
- widgetType: 'claude-usage'
- cacheKey: 'console'

If cached entry exists:
1. Immediately set state with cached.data (setClaudeCode, setPlanConfig, setConsoleUsage)
2. Set isLoading to false (display cached data immediately)
3. Add new state for staleness: const [isStale, setIsStale] = useState(false)
4. Set isStale to isCacheStale(entry, 5 * 60 * 1000) (5-minute threshold)

After displaying cached data, call fetchData() to get fresh data in background.

When fetchData completes successfully:
1. Update state with fresh data
2. Set isStale to false
3. Call setCachedWidget('claude-usage', 'console', { claudeCode, planConfig, consoleUsage })

Cache data structure should match: { claudeCode, planConfig, consoleUsage } (the three data sources).

Do NOT change existing error handling or loading states - cache should enhance, not replace.
Do NOT add cache operations inside try/catch - cache utilities already handle errors silently.
  </action>
  <verify>
1. Component renders immediately with cached data (no loading spinner if cache exists)
2. Background fetch occurs after cache display
3. Cache updates after successful fetch
4. localStorage shows 'widget-cache-v1' with 'claude-usage:console' entry
5. Inspect entry in DevTools → Application → Local Storage
  </verify>
  <done>
- getCachedWidget called on mount before fetchData
- Cached data displayed immediately if available
- isStale state added and calculated
- setCachedWidget called after successful fetchData
- Cache structure: { claudeCode, planConfig, consoleUsage }
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add staleness indicator to UI</name>
  <files>src/components/a2ui/ClaudeUsageCard.tsx</files>
  <action>
Add visual staleness indicator when isStale is true.

Position: Below the "Claude" header, before plan info section.

Design:
- Only show if isStale === true
- Use amber/yellow color scheme (not red - data is working, just old)
- Include cache age in human-readable format
- Format: "Cached Xm ago • Updating..." (while fetching) or "Cached Xm ago" (after fetch fails)

Implementation:
1. Calculate age: const ageMinutes = Math.floor(getCacheAge(cachedEntry) / 1000 / 60)
2. Store cached entry in state to preserve age calculation
3. Show indicator: "Cached {ageMinutes}m ago" with amber text color
4. Optional: Add small clock icon (from lucide-react) for visual clarity

Styling:
- text-amber-600 for text color
- text-xs or text-sm for font size
- mb-2 spacing before plan info
- Subtle, not prominent (cached data is better than no data)

Do NOT show indicator if cache was fresh (<5 min) and fresh data already loaded.
Do NOT block UI or prevent interaction while showing staleness.
  </action>
  <verify>
1. Clear cache: localStorage.removeItem('widget-cache-v1')
2. Load page → no indicator (no cache)
3. Wait 6+ minutes
4. Reload page → indicator shows "Cached Xm ago"
5. After fetch completes → indicator disappears
6. Verify amber text color and non-intrusive placement
  </verify>
  <done>
- Staleness indicator displays when isStale === true
- Shows cache age in minutes
- Amber/yellow color (text-amber-600)
- Positioned below header, above plan info
- Disappears when fresh data arrives
- No TypeScript errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Cache hydration layer with instant widget rendering and staleness indicators</what-built>
  <how-to-verify>
Test cache behavior:

1. Clear cache and load fresh:
   - Open DevTools → Console
   - Run: localStorage.removeItem('widget-cache-v1')
   - Reload page
   - Expect: Loading spinner, then widget appears, cache saved to localStorage

2. Verify instant rendering:
   - Reload page (cache now exists)
   - Expect: Widget appears IMMEDIATELY (no loading spinner)
   - DevTools → Network: Fetch still happens in background
   - Data updates smoothly when fetch completes

3. Test staleness indicator:
   - Wait 6+ minutes (or manually edit timestamp in localStorage)
   - Reload page
   - Expect: Widget shows with "Cached Xm ago" in amber text
   - After fetch completes, indicator disappears

4. Verify cache structure:
   - DevTools → Application → Local Storage → http://localhost:3000
   - Check 'widget-cache-v1' contains entry for 'claude-usage:console'
   - Verify entry has: data, timestamp, version, widgetType fields

5. Test error scenarios:
   - Disable network in DevTools
   - Reload page
   - Expect: Cached data still displays with staleness indicator
   - Widget remains functional with old data
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Widget displays cached data immediately on reload (no loading spinner)
- [ ] Background fetch occurs and updates data smoothly
- [ ] Staleness indicator shows for old cache (>5 min)
- [ ] localStorage contains 'claude-usage:console' entry with correct structure
- [ ] No TypeScript errors or build warnings
- [ ] Cache failures don't break widget (graceful degradation)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ClaudeUsageCard hydrates from cache on mount
- Cached data displays instantly before fetch
- Staleness indicator shows when cache is old
- Fresh data updates cache after successful fetch
- No regression in existing functionality
- No console errors or warnings
  </success_criteria>

<output>
After completion, create `.planning/phases/43-widget-cache-hydration/43-01-SUMMARY.md`:

# Phase 43 Plan 1: Widget Cache Hydration Layer Summary

**[One-line description of what shipped]**

## Accomplishments

- [Key achievements]
- [Cache integration details]
- [UI enhancements]

## Files Created/Modified

- `src/components/a2ui/ClaudeUsageCard.tsx` - Added cache hydration and staleness indicator

## Technical Implementation

**Cache Integration:**
- [How cache was integrated]
- [Staleness detection approach]
- [Update strategy]

**Data Flow:**
1. Component mounts
2. Check cache
3. Display cached data (if exists)
4. Fetch fresh data in background
5. Update display and cache

## Decisions Made

[Key implementation decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 43 complete (1/1 plans). Ready for Phase 44 (Background Fetch System).

**Notes for Phase 44:**
- Cache hydration pattern established in ClaudeUsageCard
- Can replicate to other widgets using same pattern
- Background fetch deduplication may be needed for multiple widgets
</output>
