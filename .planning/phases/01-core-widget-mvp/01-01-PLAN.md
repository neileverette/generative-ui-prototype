# Plan: Phase 1 - Core Widget (MVP)

## Objective

Create the ClaudeUsageCard component with TypeScript interfaces, static layout, progress bar with status colors, skeleton loading states, and A2UI registry integration. This establishes the visual foundation for the Claude Usage Tracking Widget.

## Execution Context

**Files to reference:**
- `src/types/a2ui.ts` - Type patterns for A2UI components
- `src/components/a2ui/MetricCard.tsx` - Component structure pattern
- `src/components/a2ui/ProgressBar.tsx` - Progress bar with status colors
- `src/components/DashboardCanvas.tsx` - Component registry pattern
- `.planning/features/CLAUDE_USAGE_WIDGET.md` - Full specification

**Key patterns to follow:**
- A2UI component interface extends `A2UIComponentBase`
- Props interface defined above component function
- Status colors use semantic tokens: `accent-success`, `accent-warning`, `accent-danger`
- Skeleton loaders use `animate-pulse` with gray backgrounds
- Components receive `{ component, className }` props pattern

## Context

This is Phase 1 of 4 for the Claude Usage Widget feature. The widget will display:
1. **Top section**: Claude Code subscription usage (5-hour window, daily costs, model breakdown)
2. **Bottom section**: API Credits usage (balance, burn rate, runway)

Phase 1 focuses on the static structure and visual design. Data integration comes in Phase 2.

**Design states:**
- Normal: Blue/indigo progress bar
- Warning (>70%): Yellow/amber progress bar
- Critical (>90%): Red progress bar with pulse animation

## Tasks

### Task 1: Create TypeScript interfaces
**File:** `src/types/claude-usage.ts`

Create comprehensive type definitions for:

```typescript
// Plan types
export type ClaudePlanTier = 'free' | 'pro' | 'max5' | 'max20';

// Usage status derived from percentage
export type UsageStatus = 'normal' | 'warning' | 'critical';

// Five-hour window usage tracking
export interface FiveHourWindow {
  used: number;        // tokens used
  limit: number;       // estimated limit
  percentage: number;  // 0-100
  resetsAt: string;    // ISO timestamp
  resetsIn: string;    // human readable "2h 14m"
}

// Daily/MTD usage stats
export interface UsageStats {
  tokens: number;
  estimatedCost: number;
  sessions: number;
}

// Model breakdown entry
export interface ModelUsage {
  model: 'opus' | 'sonnet' | 'haiku';
  tokens: number;
  cost: number;
  percentage: number;
}

// Claude Code subscription data
export interface ClaudeCodeUsage {
  plan: ClaudePlanTier;
  fiveHourWindow: FiveHourWindow;
  today: UsageStats;
  monthToDate: UsageStats;
  modelBreakdown: ModelUsage[];
  lastUpdated: string;
  dataSource: 'ccusage' | 'local-files' | 'manual';
}

// API Credits data
export interface ApiCreditsUsage {
  balance: number;
  thisMonth: {
    spend: number;
    startDate: string;
  };
  burnRate: {
    daily: number;
    monthly: number;
  };
  runway: {
    days: number;
    date: string;  // projected depletion date
  };
  modelBreakdown: Array<{
    model: string;
    spend: number;
    percentage: number;
  }>;
  lastUpdated: string;
  dataSource: 'admin-api' | 'manual';
  hasAdminApi: boolean;
}

// Component props
export interface ClaudeUsageCardProps {
  claudeCode: ClaudeCodeUsage | null;
  apiCredits: ApiCreditsUsage | null;
  showApiSection?: boolean;
  isLoading?: boolean;
  onRefresh?: () => void;
}
```

**Verification:** File compiles without TypeScript errors.

---

### Task 2: Create configuration constants
**File:** `src/config/claude-usage.config.ts`

Create configuration with plan limits, thresholds, and pricing:

```typescript
export const CLAUDE_USAGE_CONFIG = {
  // Plan token limits (approximate per 5-hour window)
  planLimits: {
    free: 10000,
    pro: 44000,
    max5: 88000,
    max20: 220000,
  },

  // Status thresholds (percentage)
  thresholds: {
    warning: 70,
    critical: 90,
  },

  // Pricing per 1M tokens (Jan 2025)
  pricing: {
    'claude-3-opus': { input: 15.00, output: 75.00 },
    'claude-3-sonnet': { input: 3.00, output: 15.00 },
    'claude-3-haiku': { input: 0.25, output: 1.25 },
    'claude-3.5-sonnet': { input: 3.00, output: 15.00 },
    'claude-4-opus': { input: 15.00, output: 75.00 },
    'claude-4-sonnet': { input: 3.00, output: 15.00 },
  },

  // Refresh intervals in milliseconds
  refreshInterval: {
    claudeCode: 300000,   // 5 minutes
    apiCredits: 3600000,  // 1 hour
  },

  // Model display colors
  modelColors: {
    opus: '#8b5cf6',    // Purple
    sonnet: '#6366f1',  // Indigo
    haiku: '#06b6d4',   // Cyan
  },
} as const;

// Helper to get status from percentage
export function getUsageStatus(percentage: number): 'normal' | 'warning' | 'critical' {
  if (percentage >= CLAUDE_USAGE_CONFIG.thresholds.critical) return 'critical';
  if (percentage >= CLAUDE_USAGE_CONFIG.thresholds.warning) return 'warning';
  return 'normal';
}
```

**Verification:** Helper function returns correct status for test values (50, 75, 95).

---

### Task 3: Add A2UI component type
**File:** `src/types/a2ui.ts`

Add the ClaudeUsageComponent type to the existing A2UI types:

1. Import types at top (if separate file):
```typescript
import { ClaudeCodeUsage, ApiCreditsUsage } from './claude-usage';
```

2. Add component interface:
```typescript
export interface ClaudeUsageComponent extends A2UIComponentBase {
  component: 'claude_usage';
  props: {
    claudeCode: ClaudeCodeUsage | null;
    apiCredits: ApiCreditsUsage | null;
    showApiSection?: boolean;
  };
}
```

3. Add to ComponentType union:
```typescript
export type ComponentType =
  | 'metric_card'
  | 'card_group'
  | 'data_table'
  | 'alert_list'
  | 'status_indicator'
  | 'progress_bar'
  | 'ecr_summary'
  | 'claude_usage';  // ADD THIS
```

4. Add to A2UIComponent union:
```typescript
export type A2UIComponent =
  | MetricCardComponent
  | CardGroupComponent
  | DataTableComponent
  | AlertListComponent
  | StatusIndicatorComponent
  | ProgressBarComponent
  | ECRSummaryComponent
  | ClaudeUsageComponent;  // ADD THIS
```

**Verification:** No TypeScript errors in a2ui.ts after changes.

---

### Task 4: Create ClaudeUsageCard component
**File:** `src/components/a2ui/ClaudeUsageCard.tsx`

Create the main widget component with two sections:

**Structure:**
```
+----------------------------------------------------------+
|  CLAUDE CODE                               [Plan Badge]   |
+----------------------------------------------------------+
|  5-Hour Window                                           |
|  [===================-------]  78%                       |
|  Resets in 2h 14m                                        |
|                                                          |
|  +----------+  +----------+  +----------+                |
|  |  Today   |  |   MTD    |  | Sessions |                |
|  |  $4.20   |  |  $48.50  |  |    12    |                |
|  +----------+  +----------+  +----------+                |
|                                                          |
|  Model Usage Today                                       |
|  Opus [========--] $3.20                                 |
|  Sonnet [==--------] $0.80                               |
+----------------------------------------------------------+
|  API CREDITS                                             |
+----------------------------------------------------------+
|  Balance: $127.45                  Runway: ~73 days      |
|  [============================----------]                 |
|                                                          |
|  This Month: $52.30           Burn Rate: $1.74/day       |
+----------------------------------------------------------+
```

**Key implementation details:**

1. **Props interface:**
```typescript
interface ClaudeUsageCardComponentProps {
  component: ClaudeUsageComponent;
  className?: string;
}
```

2. **Status-based progress bar colors:**
```typescript
const STATUS_COLORS = {
  normal: 'bg-accent-primary',      // Indigo
  warning: 'bg-accent-warning',     // Amber
  critical: 'bg-accent-danger',     // Red
};
```

3. **Skeleton loader component** for loading state (reuse pattern from MetricCard)

4. **Section divider** between Claude Code and API Credits sections

5. **Empty state messaging:**
   - Claude Code: "Run ccusage to populate data"
   - API Credits: "Configure Admin API key for live data"

6. **Critical state animation:** Add pulse animation to card border when >90%

**Component exports:**
```typescript
export function ClaudeUsageCard({ component, className }: ClaudeUsageCardComponentProps) {
  // ...implementation
}
```

**Verification:** Component renders without errors with null data (shows skeleton/empty state).

---

### Task 5: Register component in DashboardCanvas
**File:** `src/components/DashboardCanvas.tsx`

1. Add import at top:
```typescript
import { ClaudeUsageCard } from './a2ui/ClaudeUsageCard';
```

2. Add to COMPONENT_REGISTRY:
```typescript
const COMPONENT_REGISTRY: Record<string, React.ComponentType<any>> = {
  metric_card: MetricCard,
  card_group: CardGroup,
  data_table: DataTable,
  alert_list: AlertList,
  status_indicator: StatusIndicator,
  progress_bar: ProgressBar,
  ecr_summary: ECRSummaryCard,
  claude_usage: ClaudeUsageCard,  // ADD THIS
};
```

**Verification:** No import or registry errors.

---

### Task 6: Create mock data for testing
**File:** `src/components/a2ui/ClaudeUsageCard.tsx` (add at bottom or separate file)

Add mock data generator for visual testing:

```typescript
export const MOCK_CLAUDE_CODE_USAGE: ClaudeCodeUsage = {
  plan: 'pro',
  fiveHourWindow: {
    used: 34320,
    limit: 44000,
    percentage: 78,
    resetsAt: new Date(Date.now() + 2 * 60 * 60 * 1000 + 14 * 60 * 1000).toISOString(),
    resetsIn: '2h 14m',
  },
  today: {
    tokens: 156000,
    estimatedCost: 4.20,
    sessions: 12,
  },
  monthToDate: {
    tokens: 1850000,
    estimatedCost: 48.50,
    sessions: 89,
  },
  modelBreakdown: [
    { model: 'opus', tokens: 120000, cost: 3.20, percentage: 76 },
    { model: 'sonnet', tokens: 30000, cost: 0.80, percentage: 19 },
    { model: 'haiku', tokens: 6000, cost: 0.20, percentage: 5 },
  ],
  lastUpdated: new Date().toISOString(),
  dataSource: 'ccusage',
};

export const MOCK_API_CREDITS: ApiCreditsUsage = {
  balance: 127.45,
  thisMonth: {
    spend: 52.30,
    startDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString(),
  },
  burnRate: {
    daily: 1.74,
    monthly: 52.20,
  },
  runway: {
    days: 73,
    date: new Date(Date.now() + 73 * 24 * 60 * 60 * 1000).toISOString(),
  },
  modelBreakdown: [
    { model: 'claude-3-opus', spend: 28.40, percentage: 54 },
    { model: 'claude-3-sonnet', spend: 18.90, percentage: 36 },
    { model: 'claude-3-haiku', spend: 5.00, percentage: 10 },
  ],
  lastUpdated: new Date().toISOString(),
  dataSource: 'manual',
  hasAdminApi: false,
};
```

**Verification:** Mock data matches interface types.

---

## Verification

After completing all tasks, verify:

1. **TypeScript compilation:** `npm run build` succeeds without type errors
2. **Component renders:** Add a test usage to App.tsx temporarily:
   ```typescript
   const testComponent: ClaudeUsageComponent = {
     id: 'claude-usage-test',
     component: 'claude_usage',
     source: 'test',
     priority: 'high',
     timestamp: new Date().toISOString(),
     props: {
       claudeCode: MOCK_CLAUDE_CODE_USAGE,
       apiCredits: MOCK_API_CREDITS,
       showApiSection: true,
     },
   };
   ```
3. **Visual states:** Test with percentage values of 50 (normal), 75 (warning), 95 (critical)
4. **Loading state:** Test with `claudeCode: null` and `apiCredits: null`

## Success Criteria

- [ ] TypeScript interfaces compile without errors
- [ ] Configuration file exports constants and helper function
- [ ] A2UI types updated with ClaudeUsageComponent
- [ ] ClaudeUsageCard component renders with mock data
- [ ] Component registered in DashboardCanvas
- [ ] Progress bar shows correct colors for normal/warning/critical states
- [ ] Skeleton loading states display when data is null
- [ ] Card has pulse animation in critical state (>90%)

## Output

**Files created/modified:**
- `src/types/claude-usage.ts` (NEW)
- `src/config/claude-usage.config.ts` (NEW)
- `src/types/a2ui.ts` (MODIFIED - add claude_usage type)
- `src/components/a2ui/ClaudeUsageCard.tsx` (NEW)
- `src/components/DashboardCanvas.tsx` (MODIFIED - add to registry)

**Next phase:** Phase 2 - Local Data Integration (connect to ccusage CLI and JSONL files)
