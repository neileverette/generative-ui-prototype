# Plan 03-01: API Credits Section

## Goal

Add API Credits tracking to the widget with manual entry support. Since the Anthropic Admin API requires organization accounts (not available for individual users), we'll implement manual entry as the primary method with Admin API as an optional enhancement.

## Context

- Phase 2 delivered real Claude Code usage tracking
- API Credits section already exists in UI with placeholder state
- Types `ApiCreditsUsage` already defined in `src/types/claude-usage.ts`
- Widget shows "Configure Admin API key for live data" message when no data

## Approach

Focus on manual entry first (works for all users), with Admin API support as optional:
1. Create backend storage for manual credit entries (JSON file)
2. Add backend endpoint for CRUD operations
3. Add MCP client method
4. Connect widget to fetch/display real data
5. Add simple inline entry form (not a full modal - defer to Phase 4)

## Tasks

### 1. Create backend storage utilities
**File:** `server/api-credits-storage.ts`
- Define storage interface for credit entries
- JSON file storage at `.config/api-credits.json`
- Functions: `loadCredits()`, `saveCredits()`, `updateBalance()`
- Track balance history for burn rate calculation

### 2. Create burn rate calculation logic
**File:** `server/api-credits-storage.ts` (extend)
- Calculate daily burn rate from balance history
- Project runway (days until depletion)
- Handle edge cases (no history, single entry)

### 3. Create backend API endpoints
**File:** `server/index.ts` (modify)
- `GET /api/claude-usage/api-credits` - Get current credits data
- `POST /api/claude-usage/api-credits` - Update balance (manual entry)
- Transform storage data to `ApiCreditsUsage` format

### 4. Add MCP client methods
**File:** `src/services/mcp-client.ts` (modify)
- `getApiCredits()` - Fetch current API credits data
- `updateApiCredits(balance: number)` - Update balance via manual entry

### 5. Connect widget to real data
**File:** `src/components/a2ui/ClaudeUsageCard.tsx` (modify)
- Fetch API credits data on mount
- Add inline balance input when no data exists
- Display real burn rate and runway

### 6. Build verification
- Run `npm run build`
- Verify no TypeScript errors

## Verification

- [ ] JSON storage file created on first save
- [ ] GET endpoint returns proper ApiCreditsUsage format
- [ ] POST endpoint saves balance and updates burn rate
- [ ] Widget displays real data when available
- [ ] Inline entry form works for initial setup
- [ ] Build passes

## Files

| File | Action | Purpose |
|------|--------|---------|
| `server/api-credits-storage.ts` | Create | Storage utilities, burn rate calc |
| `server/index.ts` | Modify | Add API endpoints |
| `src/services/mcp-client.ts` | Modify | Add client methods |
| `src/components/a2ui/ClaudeUsageCard.tsx` | Modify | Connect to real data, inline entry |

## Notes

- Deferring Admin API integration - requires org account
- Deferring full settings modal to Phase 4
- Using simple inline entry for initial balance setup
- Storage file location: `.config/api-credits.json` (gitignored)
