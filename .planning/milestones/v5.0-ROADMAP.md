# Milestone v5.0: Claude Data Hydration

**Status:** ✅ SHIPPED 2025-01-24
**Phases:** 16-21
**Total Plans:** 6

## Overview

Replace fake/hardcoded data in ClaudeUsageCard with real API data from Claude/Anthropic services. Currently, the card displays magenta-colored placeholders for current session, weekly limits, and plan info - all need to be connected to real data sources.

The milestone discovered that no public API exists for Claude Console usage metrics, leading to an innovative AppleScript-based scraping solution that runs silently in the background every 5 minutes.

## Phases

### Phase 16: API Research & Strategy

**Goal**: Research Anthropic API options, Console scraping alternatives, and determine best approach for each data point
**Depends on**: Milestone 4 complete
**Plans**: 1 plan

Plans:
- [x] 16-01: Research API options and create integration strategy

**Details:**

Research revealed no public API exists for Claude Console usage data. The Anthropic Admin API and Usage API only cover API usage, not Console usage metrics. Console data is only accessible via the web interface at console.anthropic.com/settings/usage.

Solution: AppleScript-based scraper that automates browser interaction with the Console to extract usage data.

**Key Findings:**
- No official API for Console metrics
- Scraping is the only viable approach
- Created both visible (`scrape.sh`) and silent (`scrape-silent.sh`) variants
- 5-minute refresh interval balances freshness vs. performance

### Phase 17: API Infrastructure Setup

**Goal**: Create API client, authentication, error handling, and rate limiting infrastructure
**Depends on**: Phase 16
**Plans**: 1 plan

Plans:
- [x] 17-01: Build API client infrastructure

**Details:**

Built complete server-side infrastructure for Console usage data:

**Server Endpoints:**
- GET /api/claude-usage/console - Fetch latest Console usage data
- POST /api/claude-usage/console - Store scraped Console data
- POST /api/claude-usage/console/refresh - Trigger immediate scrape

**MCP Client Methods:**
- `getConsoleUsage()` - Fetch current Console usage
- `refreshConsoleUsage()` - Trigger manual refresh

**Auto-Scraper Service:**
- Background service runs every 5 minutes
- Uses `scrape-silent.sh` to avoid user interruption
- Automatically POST results to server endpoint
- Keeps data fresh without manual intervention

**Files Modified:**
- server/index.ts - Added 3 new endpoints
- src/services/mcp-client.ts - Added 2 new methods
- server/claude-scraper/ - Complete scraper infrastructure (~20 files)

### Phase 18: Current Session Data Integration

**Goal**: Connect current session usage to real-time data source
**Depends on**: Phase 17
**Plans**: 1 plan

Plans:
- [x] 18-01: Integrate current session data

**Details:**

Integrated ClaudeUsageCard with real Console usage data for current session (5-hour window).

**Key Changes:**
- Replaced fake data with real scraped Console data
- Progress bar shows actual usage percentage (72% in production)
- Reset timer displays real countdown to next window reset
- Color coding added: blue <80%, red >=80%
- Removed magenta placeholder styling from current session

**Data Flow:**
```
Browser Console → scrape-silent.sh → POST /api/claude-usage/console →
MCP Client getConsoleUsage() → ClaudeUsageCard → UI
```

### Phase 19: Weekly Limits Integration

**Goal**: Integrate weekly limits (all models + Sonnet only) with real data
**Depends on**: Phase 18
**Plans**: 1 plan

Plans:
- [x] 19-01: Integrate weekly limits data

**Details:**

Integrated weekly usage limits (all models + Sonnet only) with real Console data.

**Key Changes:**
- Weekly limit (all models) - Real data showing 27% used
- Weekly limit (Sonnet only) - Real data showing 4% used
- Both limits updated on 5-minute auto-refresh cycle
- Manual refresh triggers immediate update for both
- Color-coded progress bars (blue <80%, red >=80%)
- Removed magenta placeholder styling from weekly sections

**Data Integration:**
- Fetched from same Console scrape as current session
- Reset day countdown calculated from real Console data
- Shared refresh cycle ensures consistency

### Phase 20: Plan & Billing Info Integration

**Goal**: Connect plan details, cost, and billing date to real source
**Depends on**: Phase 19
**Plans**: 1 plan

Plans:
- [x] 20-01: Integrate plan and billing data

**Details:**

Connected plan information to real configuration source.

**Approach:** Configuration file vs. API
- Plan details rarely change
- Config file allows easy updates without code changes
- Avoids unnecessary API calls
- Single source of truth at `server/claude-config.json`

**Key Changes:**
- Plan info sourced from `server/claude-config.json`
- Plan name and tier displayed
- Monthly cost shown
- Next billing date calculated
- Removed magenta placeholder styling from plan section

### Phase 21: Cleanup & Testing

**Goal**: Remove fake data fallbacks, add comprehensive error handling, test edge cases
**Depends on**: Phase 20
**Plans**: 1 plan

Plans:
- [x] 21-01: Clean up fake data and add comprehensive testing

**Details:**

Final cleanup and comprehensive testing of all data integrations.

**Key Changes:**
1. Removed all fake/hardcoded data
   - No more placeholder percentages
   - No more magenta styling
   - All data from real sources

2. Added stale data warnings
   - Displays warning if data >10 minutes old
   - Prompts user to refresh manually
   - 10-minute threshold balances UX vs. false warnings

3. Error handling improvements
   - Loading states for all data sections
   - Graceful degradation on API failures
   - User-friendly error messages

4. Testing completed
   - Auto-refresh working (5-minute intervals)
   - Manual refresh triggers immediate scrape
   - Stale data detection working correctly
   - All progress bars display real percentages
   - Color coding (blue/red) working correctly

**Result:**
ClaudeUsageCard now displays 100% real data from Claude Console:
- Current session: Real percentages (72%)
- Weekly limits: Real data (27% all models, 4% Sonnet)
- Plan info: Real configuration
- Auto-refresh: Every 5 minutes via silent scraper
- Manual refresh: On-demand scraping
- Stale data: Warning when >10 minutes old

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| AppleScript scraping | No public API for Console data | ✅ Works reliably |
| Silent scraper variant | Avoid interrupting user workflow | ✅ Runs in background |
| 5-minute auto-refresh | Balance freshness vs. performance | ✅ Good UX |
| 10-minute stale threshold | Balance warnings vs. false positives | ✅ Good balance |
| Config file for plan info | Plan changes infrequently | ✅ Simple and effective |

**Issues Resolved:**
- No public API for Console usage data → Created scraping solution
- User interruption during scraping → Built silent scraper
- Stale data concerns → Added auto-refresh every 5 minutes
- Manual refresh needed → Added refresh button triggering immediate scrape

**Issues Deferred:**
- None - all requirements met

**Technical Debt Incurred:**
- Scraping solution depends on Console UI stability (will break if Anthropic changes layout)
- Consider monitoring for scraper failures and alerting user
- Future: Migrate to official API when/if Anthropic releases one

---

_For current project status, see .planning/ROADMAP.md_
